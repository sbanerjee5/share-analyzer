import React, { useState } from 'react';
import { Search, TrendingUp, TrendingDown, Minus, Download, Loader2, AlertCircle } from 'lucide-react';
import { jsPDF } from 'jspdf';
import autoTable from 'jspdf-autotable';

const ShareAnalyzer = () => {
  const [ticker, setTicker] = useState('');
  const [loading, setLoading] = useState(false);
  const [analysis, setAnalysis] = useState(null);
  const [error, setError] = useState(null);

  const analyzeStock = async () => {
    if (!ticker.trim()) return;
    
    setLoading(true);
    setError(null);
    
    try {
      const response = await fetch('http://localhost:8000/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ticker: ticker.toUpperCase() })
      });
      
      const data = await response.json();
      
      if (data.success) {
        setAnalysis(data);
      } else {
        setError('Failed to analyze stock');
      }
    } catch (err) {
      setError('Unable to connect to backend. Make sure the FastAPI server is running on port 8000.');
    } finally {
      setLoading(false);
    }
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      analyzeStock();
    }
  };

  const generatePDF = () => {
  if (!analysis) return;
  
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.width;
  
  // Title
  doc.setFontSize(24);
  doc.setTextColor(59, 130, 246); // Blue color
  doc.text('UK Share Analyzer Report', pageWidth / 2, 20, { align: 'center' });
  
  // Company Info
  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text(analysis.company.name, pageWidth / 2, 35, { align: 'center' });
  
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`Ticker: ${analysis.company.ticker}`, pageWidth / 2, 42, { align: 'center' });
  doc.text(`Price: ${analysis.company.currency} ${analysis.company.price}`, pageWidth / 2, 49, { align: 'center' });
  doc.text(`Date: ${new Date(analysis.timestamp).toLocaleDateString()}`, pageWidth / 2, 56, { align: 'center' });
  
  // Recommendation Box
  let recColor;
  if (analysis.recommendation.recommendation === 'BUY') {
    recColor = [34, 197, 94]; // Green
  } else if (analysis.recommendation.recommendation === 'SELL') {
    recColor = [239, 68, 68]; // Red
  } else {
    recColor = [234, 179, 8]; // Yellow
  }
  
  doc.setFillColor(...recColor);
  doc.rect(15, 65, pageWidth - 30, 25, 'F');
  
  doc.setFontSize(18);
  doc.setTextColor(255, 255, 255);
  doc.text(`RECOMMENDATION: ${analysis.recommendation.recommendation}`, pageWidth / 2, 75, { align: 'center' });
  doc.text(`Overall Score: ${analysis.recommendation.score}/100`, pageWidth / 2, 85, { align: 'center' });
  
  // KPI Tables
  let yPosition = 100;
  
  // Valuation Metrics
  doc.setFontSize(14);
  doc.setTextColor(59, 130, 246);
  doc.text('Valuation Metrics', 15, yPosition);
  yPosition += 5;
  
  doc.autoTable({
    startY: yPosition,
    head: [['Metric', 'Value', 'Score']],
    body: [
      ['P/E Ratio', analysis.kpis.valuation.pe_ratio.value || 'N/A', `${analysis.kpis.valuation.pe_ratio.score}/10`],
      ['P/B Ratio', analysis.kpis.valuation.pb_ratio.value || 'N/A', `${analysis.kpis.valuation.pb_ratio.score}/10`],
    ],
    theme: 'grid',
    headStyles: { fillColor: [59, 130, 246] },
  });
  
  yPosition = doc.lastAutoTable.finalY + 10;
  
  // Profitability Metrics
  doc.setTextColor(34, 197, 94);
  doc.text('Profitability Metrics', 15, yPosition);
  yPosition += 5;
  
  doc.autoTable({
    startY: yPosition,
    head: [['Metric', 'Value', 'Score']],
    body: [
      ['ROE', analysis.kpis.profitability.roe.value ? `${analysis.kpis.profitability.roe.value}%` : 'N/A', `${analysis.kpis.profitability.roe.score}/10`],
      ['Profit Margin', analysis.kpis.profitability.profit_margin.value ? `${analysis.kpis.profitability.profit_margin.value}%` : 'N/A', `${analysis.kpis.profitability.profit_margin.score}/10`],
      ['Operating Margin', analysis.kpis.profitability.operating_margin.value ? `${analysis.kpis.profitability.operating_margin.value}%` : 'N/A', `${analysis.kpis.profitability.operating_margin.score}/10`],
    ],
    theme: 'grid',
    headStyles: { fillColor: [34, 197, 94] },
  });
  
  yPosition = doc.lastAutoTable.finalY + 10;
  
  // Financial Health
  doc.setTextColor(168, 85, 247);
  doc.text('Financial Health', 15, yPosition);
  yPosition += 5;
  
  doc.autoTable({
    startY: yPosition,
    head: [['Metric', 'Value', 'Score']],
    body: [
      ['Debt-to-Equity', analysis.kpis.health.debt_to_equity.value || 'N/A', `${analysis.kpis.health.debt_to_equity.score}/10`],
      ['Current Ratio', analysis.kpis.health.current_ratio.value || 'N/A', `${analysis.kpis.health.current_ratio.score}/10`],
    ],
    theme: 'grid',
    headStyles: { fillColor: [168, 85, 247] },
  });
  
  // Add new page for remaining metrics
  doc.addPage();
  yPosition = 20;
  
  // Growth Metrics
  doc.setTextColor(234, 179, 8);
  doc.text('Growth Metrics', 15, yPosition);
  yPosition += 5;
  
  doc.autoTable({
    startY: yPosition,
    head: [['Metric', 'Value', 'Score']],
    body: [
      ['Revenue Growth', analysis.kpis.growth.revenue_growth.value ? `${analysis.kpis.growth.revenue_growth.value}%` : 'N/A', `${analysis.kpis.growth.revenue_growth.score}/10`],
      ['EPS Growth', analysis.kpis.growth.eps_growth.value ? `${analysis.kpis.growth.eps_growth.value}%` : 'N/A', `${analysis.kpis.growth.eps_growth.score}/10`],
    ],
    theme: 'grid',
    headStyles: { fillColor: [234, 179, 8] },
  });
  
  yPosition = doc.lastAutoTable.finalY + 10;
  
  // Technical Metrics
  doc.setTextColor(249, 115, 22);
  doc.text('Technical & Market', 15, yPosition);
  yPosition += 5;
  
  doc.autoTable({
    startY: yPosition,
    head: [['Metric', 'Value', 'Score']],
    body: [
      ['Beta', analysis.kpis.technical.beta.value || 'N/A', `${analysis.kpis.technical.beta.score}/10`],
      ['52W Price Position', analysis.kpis.technical.price_position.value ? `${analysis.kpis.technical.price_position.value}%` : 'N/A', `${analysis.kpis.technical.price_position.score}/10`],
      ['Dividend Yield', analysis.kpis.technical.dividend_yield.value ? `${analysis.kpis.technical.dividend_yield.value}%` : 'N/A', `${analysis.kpis.technical.dividend_yield.score}/10`],
    ],
    theme: 'grid',
    headStyles: { fillColor: [249, 115, 22] },
  });
  
  yPosition = doc.lastAutoTable.finalY + 15;
  
  // Disclaimer
  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  const disclaimer = 'Disclaimer: This analysis is for informational purposes only and does not constitute financial advice. Always conduct your own research and consult with a qualified financial advisor before making investment decisions.';
  const splitDisclaimer = doc.splitTextToSize(disclaimer, pageWidth - 30);
  doc.text(splitDisclaimer, 15, yPosition);
  
  // Save PDF
  const fileName = `${analysis.company.ticker}_Analysis_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);
};

  const getRecommendationIcon = (rec) => {
    if (rec === 'BUY') return <TrendingUp className="w-8 h-8" />;
    if (rec === 'SELL') return <TrendingDown className="w-8 h-8" />;
    return <Minus className="w-8 h-8" />;
  };

  const getRecommendationColor = (rec) => {
    if (rec === 'BUY') return 'from-green-500 to-emerald-600';
    if (rec === 'SELL') return 'from-red-500 to-rose-600';
    return 'from-yellow-500 to-amber-600';
  };

  const ScoreBar = ({ score }) => {
    const percentage = (score / 10) * 100;
    const getColor = () => {
      if (score >= 7) return 'bg-green-500';
      if (score >= 4) return 'bg-yellow-500';
      return 'bg-red-500';
    };
    
    return (
      <div className="w-full bg-gray-700 rounded-full h-2 mt-2">
        <div 
          className={`h-2 rounded-full ${getColor()} transition-all duration-500`}
          style={{ width: `${percentage}%` }}
        />
      </div>
    );
  };

  const KPICard = ({ label, value, unit, score }) => (
    <div className="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
      <div className="text-gray-400 text-sm mb-1">{label}</div>
      <div className="text-2xl font-bold text-white mb-2">
        {value !== null ? `${value}${unit}` : 'N/A'}
      </div>
      <ScoreBar score={score} />
      <div className="text-xs text-gray-500 mt-1">Score: {score}/10</div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="text-center mb-12">
          <h1 className="text-5xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text">
            UK Share Analyzer
          </h1>
          <p className="text-gray-400 text-lg">
            AI-Powered Analysis for FTSE 100, FTSE 250 & AIM Markets
          </p>
        </div>

        {/* Search Section */}
        <div className="mb-12">
          <div className="flex gap-4 max-w-2xl mx-auto">
            <div className="flex-1 relative">
              <input
                type="text"
                value={ticker}
                onChange={(e) => setTicker(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="Enter ticker symbol (e.g., BARC.L, BP.L, VOD.L)"
                className="w-full px-6 py-4 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 transition-colors"
              />
            </div>
            <button
              onClick={analyzeStock}
              disabled={loading || !ticker.trim()}
              className="px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2"
            >
              {loading ? (
                <>
                  <Loader2 className="w-5 h-5 animate-spin" />
                  Analyzing
                </>
              ) : (
                <>
                  <Search className="w-5 h-5" />
                  Analyze
                </>
              )}
            </button>
          </div>
          
          {error && (
            <div className="mt-4 max-w-2xl mx-auto p-4 bg-red-900/20 border border-red-500/50 rounded-lg flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" />
              <p className="text-red-300">{error}</p>
            </div>
          )}
        </div>

        {/* Analysis Results */}
        {analysis && (
          <div className="space-y-8 animate-fadeIn">
            {/* Company Header */}
            <div className="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
              <div className="flex justify-between items-start">
                <div>
                  <h2 className="text-3xl font-bold mb-2">{analysis.company.name}</h2>
                  <p className="text-gray-400 text-lg">{analysis.company.ticker}</p>
                </div>
                <div className="text-right">
                  <div className="text-3xl font-bold">
                    {analysis.company.currency} {analysis.company.price}
                  </div>
                </div>
              </div>
            </div>

            {/* Recommendation Card */}
            <div className={`bg-gradient-to-r ${getRecommendationColor(analysis.recommendation.recommendation)} rounded-xl p-8 shadow-2xl`}>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-6">
                  {getRecommendationIcon(analysis.recommendation.recommendation)}
                  <div>
                    <div className="text-sm opacity-90 mb-1">RECOMMENDATION</div>
                    <div className="text-4xl font-bold">{analysis.recommendation.recommendation}</div>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-sm opacity-90 mb-1">OVERALL SCORE</div>
                  <div className="text-5xl font-bold">{analysis.recommendation.score}/100</div>
                </div>
              </div>
              <p className="mt-4 text-lg opacity-90">{analysis.recommendation.message}</p>
            </div>

            {/* KPI Sections */}
            <div className="space-y-6">
              {/* Valuation */}
              <div className="bg-gray-800/30 rounded-xl p-6 border border-gray-700">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-2xl font-bold text-blue-400">Valuation Metrics</h3>
                  <div className="text-lg">
                    Score: <span className="font-bold">{analysis.recommendation.category_scores.valuation}/10</span>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <KPICard 
                    label="P/E Ratio" 
                    value={analysis.kpis.valuation.pe_ratio.value} 
                    unit="" 
                    score={analysis.kpis.valuation.pe_ratio.score}
                  />
                  <KPICard 
                    label="P/B Ratio" 
                    value={analysis.kpis.valuation.pb_ratio.value} 
                    unit="" 
                    score={analysis.kpis.valuation.pb_ratio.score}
                  />
                </div>
              </div>

              {/* Profitability */}
              <div className="bg-gray-800/30 rounded-xl p-6 border border-gray-700">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-2xl font-bold text-green-400">Profitability Metrics</h3>
                  <div className="text-lg">
                    Score: <span className="font-bold">{analysis.recommendation.category_scores.profitability}/10</span>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <KPICard 
                    label="ROE" 
                    value={analysis.kpis.profitability.roe.value} 
                    unit="%" 
                    score={analysis.kpis.profitability.roe.score}
                  />
                  <KPICard 
                    label="Profit Margin" 
                    value={analysis.kpis.profitability.profit_margin.value} 
                    unit="%" 
                    score={analysis.kpis.profitability.profit_margin.score}
                  />
                  <KPICard 
                    label="Operating Margin" 
                    value={analysis.kpis.profitability.operating_margin.value} 
                    unit="%" 
                    score={analysis.kpis.profitability.operating_margin.score}
                  />
                </div>
              </div>

              {/* Financial Health */}
              <div className="bg-gray-800/30 rounded-xl p-6 border border-gray-700">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-2xl font-bold text-purple-400">Financial Health</h3>
                  <div className="text-lg">
                    Score: <span className="font-bold">{analysis.recommendation.category_scores.health}/10</span>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <KPICard 
                    label="Debt-to-Equity" 
                    value={analysis.kpis.health.debt_to_equity.value} 
                    unit="" 
                    score={analysis.kpis.health.debt_to_equity.score}
                  />
                  <KPICard 
                    label="Current Ratio" 
                    value={analysis.kpis.health.current_ratio.value} 
                    unit="" 
                    score={analysis.kpis.health.current_ratio.score}
                  />
                </div>
              </div>

              {/* Growth */}
              <div className="bg-gray-800/30 rounded-xl p-6 border border-gray-700">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-2xl font-bold text-yellow-400">Growth Metrics</h3>
                  <div className="text-lg">
                    Score: <span className="font-bold">{analysis.recommendation.category_scores.growth}/10</span>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <KPICard 
                    label="Revenue Growth" 
                    value={analysis.kpis.growth.revenue_growth.value} 
                    unit="%" 
                    score={analysis.kpis.growth.revenue_growth.score}
                  />
                  <KPICard 
                    label="EPS Growth" 
                    value={analysis.kpis.growth.eps_growth.value} 
                    unit="%" 
                    score={analysis.kpis.growth.eps_growth.score}
                  />
                </div>
              </div>

              {/* Technical */}
              <div className="bg-gray-800/30 rounded-xl p-6 border border-gray-700">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-2xl font-bold text-orange-400">Technical & Market</h3>
                  <div className="text-lg">
                    Score: <span className="font-bold">{analysis.recommendation.category_scores.technical}/10</span>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <KPICard 
                    label="Beta" 
                    value={analysis.kpis.technical.beta.value} 
                    unit="" 
                    score={analysis.kpis.technical.beta.score}
                  />
                  <KPICard 
                    label="52W Price Position" 
                    value={analysis.kpis.technical.price_position.value} 
                    unit="%" 
                    score={analysis.kpis.technical.price_position.score}
                  />
                  <KPICard 
                    label="Dividend Yield" 
                    value={analysis.kpis.technical.dividend_yield.value} 
                    unit="%" 
                    score={analysis.kpis.technical.dividend_yield.score}
                  />
                </div>
              </div>
            </div>

            {/* PDF Download Button */}
            <div className="flex justify-center pt-8">
              <button
                onClick={generatePDF}
                className="px-8 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all flex items-center gap-3 text-lg"
              >
                <Download className="w-6 h-6" />
                Download PDF Report
              </button>
            </div>

            {/* Disclaimer */}
            <div className="mt-8 p-4 bg-yellow-900/20 border border-yellow-700/50 rounded-lg">
              <p className="text-sm text-yellow-200">
                <strong>Disclaimer:</strong> This analysis is for informational purposes only and does not constitute financial advice. 
                Always conduct your own research and consult with a qualified financial advisor before making investment decisions.
              </p>
            </div>
          </div>
        )}

        {/* Instructions when no analysis */}
        {!analysis && !loading && (
          <div className="text-center text-gray-400 mt-20">
            <p className="text-xl mb-4">Enter a UK stock ticker to begin analysis</p>
            <p className="text-sm">Examples: BARC.L (Barclays), BP.L (BP), VOD.L (Vodafone)</p>
          </div>
        )}
      </div>

      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.5s ease-out;
        }
      `}</style>
    </div>
  );
};

export default ShareAnalyzer;